(function(p,l){typeof exports=="object"&&typeof module<"u"?l(exports):typeof define=="function"&&define.amd?define(["exports"],l):(p=typeof globalThis<"u"?globalThis:p||self,l(p.EmpressStore={}))})(this,function(p){"use strict";const n=class n{constructor(e,t={}){this._data=e,this._listeners=new Set,this._middleware=[],this._validators=[],this._middleware=t.middleware||[],this._validators=t.validators||[]}addMiddleware(e){return this._middleware.push(e),()=>{const t=this._middleware.indexOf(e);t!==-1&&this._middleware.splice(t,1)}}addMiddlewares(e){const t=e.map(i=>this.addMiddleware(i));return()=>t.forEach(i=>i())}addValidator(e){return this._validators.push(e),()=>{const t=this._validators.indexOf(e);t!==-1&&this._validators.splice(t,1)}}addValidators(e){const t=e.map(i=>this.addValidator(i));return()=>t.forEach(i=>i())}get middleware(){return[...this._middleware]}get rawState(){return this._data}get state(){return new Proxy(this._data,{get:(e,t)=>{const i=e[t];return i instanceof Object?new Proxy(i,{}):i},set:()=>(console.warn("Direct state mutation is not allowed. Use setState instead."),!1)})}subscribe(e){return this._listeners.add(e),()=>this._listeners.delete(e)}validateUpdate(e){for(const t of this._validators){const i=t(e);if(i!==!0)throw new Error(typeof i=="string"?i:"Validation failed")}}update(e){const t=e(this.state);this.validateUpdate(t);const i=(f,c)=>({...f,...c});let a=i(this._data,t);for(const f of this._middleware)a=f(a,t,i);this._data=a,this.notifyListeners()}transaction(e){const t=this.state;try{this._data=e.apply(this.state),this.notifyListeners()}catch(i){throw this._data=e.rollback(t),this.notifyListeners(),i}}simpleTransaction(e){const t=e(this.state),i={};Object.keys(t).forEach(a=>{i[a]=this.state[a]}),this.transaction({apply:a=>({...a,...t}),rollback:a=>({...a,...i})})}reset(e={}){this._data=e,this.notifyListeners()}cloneState(){const e=t=>{if(t===null||typeof t!="object")return t;if(Array.isArray(t))return t.map(a=>e(a));const i={};for(const a in t)if(Object.prototype.hasOwnProperty.call(t,a))try{i[a]=e(t[a])}catch(f){console.warn(`Failed to clone property ${a}`,f),i[a]=t[a]}return i};return e(this._data)}notifyListeners(){if(n._isNotifying){n._pendingNotifications.add(this);return}n._notificationScheduled||(n._notificationScheduled=!0,queueMicrotask(()=>{n._isNotifying=!0;try{n._pendingNotifications.forEach(e=>{e._listeners.forEach(t=>t(e._data))})}finally{n._isNotifying=!1,n._notificationScheduled=!1,n._pendingNotifications.clear()}})),n._pendingNotifications.add(this)}};n._pendingNotifications=new Set,n._isNotifying=!1,n._notificationScheduled=!1;let l=n;const w=new Set;function m(u,e){let t,i=!1;const a=Array.isArray(u)?u:[u],f=()=>{const s=a.map(d=>d.state);return Array.isArray(u)?s:s[0]},c=a.map(s=>s.subscribe(()=>{i||(t=void 0)})),r={get value(){if(i)throw new Error("Cannot access disposed computed value");if(w.has(r))throw new Error("Circular dependency detected in computed properties");if(t===void 0){w.add(r);try{t=e(f())}finally{w.delete(r)}}return t},dispose(){i||(i=!0,c.forEach(s=>s()),t=void 0)}};return typeof window<"u"&&window.addEventListener("unload",()=>r.dispose()),r}function _(u,e={}){const t=u.reduce((c,r)=>({...c,...r.state}),{});class i extends l{cleanup(){f.forEach(r=>r())}update(r){const s=r(this.state);this.validateUpdate(s),u.forEach(d=>{const h={};let y=!1;for(const o in s)o in d.state&&d.state[o]!==s[o]&&(h[o]=s[o],y=!0);y&&d.validateUpdate(h)}),super.update(d=>s),u.forEach(d=>{const h={};let y=!1;for(const o in s)o in d.state&&d.state[o]!==s[o]&&(h[o]=s[o],y=!0);if(y){const o=d.update;d.update=function(v){l.prototype.update.call(this,v)},d.update(()=>h),d.update=o}})}}const a=new i(t,{middleware:e.middleware||[],validators:e.validators||[]}),f=u.map(c=>{const r=c.update;return c.update=function(s){const d=this.state,h=s(d);this.validateUpdate(h),a.update(y=>h)},()=>{c.update=r}});return a}p.Store=l,p.computed=m,p.mixStores=_,Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
