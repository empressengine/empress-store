(function(h,f){typeof exports=="object"&&typeof module<"u"?f(exports):typeof define=="function"&&define.amd?define(["exports"],f):(h=typeof globalThis<"u"?globalThis:h||self,f(h.EmpressStore={}))})(this,function(h){"use strict";const d=class d{constructor(e,a={}){this._data=e,this._listeners=new Set,this._middleware=[],this._validators=[],this.safeDeepClone=t=>{if(t===null||typeof t!="object")return t;if(Array.isArray(t))return t.map(n=>this.safeDeepClone(n));const i={};for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n))try{i[n]=this.safeDeepClone(t[n])}catch(l){console.warn(`Failed to clone property ${n}`,l),i[n]=t[n]}return i},this._prevData=this.safeDeepClone(this._data),this._middleware=a.middleware||[],this._validators=a.validators||[]}addMiddleware(e){return this._middleware.push(e),()=>{const a=this._middleware.indexOf(e);a!==-1&&this._middleware.splice(a,1)}}addMiddlewares(e){const a=e.map(t=>this.addMiddleware(t));return()=>a.forEach(t=>t())}addValidator(e){return this._validators.push(e),()=>{const a=this._validators.indexOf(e);a!==-1&&this._validators.splice(a,1)}}addValidators(e){const a=e.map(t=>this.addValidator(t));return()=>a.forEach(t=>t())}get middleware(){return[...this._middleware]}get rawState(){return this._data}get prev(){return this.safeDeepClone(this._prevData)}get state(){return new Proxy(this._data,{get:(e,a)=>{const t=e[a];return t instanceof Object?new Proxy(t,{}):t},set:()=>(console.warn("Direct state mutation is not allowed. Use setState instead."),!1)})}subscribe(e){return this._listeners.add(e),()=>this._listeners.delete(e)}validateUpdate(e){for(const a of this._validators){const t=a(e);if(t!==!0)throw new Error(typeof t=="string"?t:"Validation failed")}}update(e){const a=e(this.state);this.validateUpdate(a);const t=(n,l)=>({...n,...l});let i=t(this._data,a);for(const n of this._middleware)i=n(i,a,t);this._prevData=this.safeDeepClone(this._data),this._data=i,this.notifyListeners()}transaction(e){const a=this.state;try{this._prevData=this.safeDeepClone(this._data),this._data=e.apply(this.state),this.notifyListeners()}catch(t){throw this._data=e.rollback(a),this.notifyListeners(),t}}simpleTransaction(e){const a=e(this.state),t={};Object.keys(a).forEach(i=>{t[i]=this.state[i]}),this.transaction({apply:i=>({...i,...a}),rollback:i=>({...i,...t})})}reset(e={}){this._prevData=this.safeDeepClone(this._data),this._data=e,this.notifyListeners()}cloneState(){return this.safeDeepClone(this._data)}clonePrevState(){return this.safeDeepClone(this._prevData)}notifyListeners(){if(d._isNotifying){d._pendingNotifications.add(this);return}d._notificationScheduled||(d._notificationScheduled=!0,queueMicrotask(()=>{d._isNotifying=!0;try{d._pendingNotifications.forEach(e=>{e._listeners.forEach(a=>a(e._data,e._prevData))})}finally{d._isNotifying=!1,d._notificationScheduled=!1,d._pendingNotifications.clear()}})),d._pendingNotifications.add(this)}};d._pendingNotifications=new Set,d._isNotifying=!1,d._notificationScheduled=!1;let f=d;const _=new Set;function w(p,e){let a,t=!1;const i=Array.isArray(p)?p:[p],n=()=>{const s=i.map(r=>r.state);return Array.isArray(p)?s:s[0]},l=i.map(s=>s.subscribe(()=>{t||(a=void 0)})),o={get value(){if(t)throw new Error("Cannot access disposed computed value");if(_.has(o))throw new Error("Circular dependency detected in computed properties");if(a===void 0){_.add(o);try{a=e(n())}finally{_.delete(o)}}return a},dispose(){t||(t=!0,l.forEach(s=>s()),a=void 0)}};return typeof window<"u"&&window.addEventListener("unload",()=>o.dispose()),o}function v(p,e={}){const a=p.reduce((l,o)=>({...l,...o.state}),{});class t extends f{cleanup(){n.forEach(o=>o())}update(o){const s=o(this.state);this.validateUpdate(s),p.forEach(r=>{const u={};let y=!1;for(const c in s)c in r.state&&r.state[c]!==s[c]&&(u[c]=s[c],y=!0);y&&r.validateUpdate(u)}),super.update(r=>s),p.forEach(r=>{const u={};let y=!1;for(const c in s)c in r.state&&r.state[c]!==s[c]&&(u[c]=s[c],y=!0);if(y){const c=r.update;r.update=function(m){f.prototype.update.call(this,m)},r.update(()=>u),r.update=c}})}}const i=new t(a,{middleware:e.middleware||[],validators:e.validators||[]}),n=p.map(l=>{const o=l.update;return l.update=function(s){const r=this.state,u=s(r);this.validateUpdate(u),i.update(y=>u)},()=>{l.update=o}});return i}h.Store=f,h.computed=w,h.mixStores=v,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
