(function(p,f){typeof exports=="object"&&typeof module<"u"?f(exports):typeof define=="function"&&define.amd?define(["exports"],f):(p=typeof globalThis<"u"?globalThis:p||self,f(p.EmpressStore={}))})(this,function(p){"use strict";const d=class d{constructor(e,i={}){this._data=e,this._listeners=new Set,this._middleware=[],this._validators=[],this.safeDeepClone=t=>{if(t===null||typeof t!="object")return t;if(Array.isArray(t))return t.map(n=>this.safeDeepClone(n));const a={};for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n))try{a[n]=this.safeDeepClone(t[n])}catch(l){console.warn(`Failed to clone property ${n}`,l),a[n]=t[n]}return a},this._prevData=this.safeDeepClone(this._data),this._middleware=i.middleware||[],this._validators=i.validators||[]}addMiddleware(e){return this._middleware.push(e),()=>{const i=this._middleware.indexOf(e);i!==-1&&this._middleware.splice(i,1)}}addMiddlewares(e){const i=e.map(t=>this.addMiddleware(t));return()=>i.forEach(t=>t())}addValidator(e){return this._validators.push(e),()=>{const i=this._validators.indexOf(e);i!==-1&&this._validators.splice(i,1)}}addValidators(e){const i=e.map(t=>this.addValidator(t));return()=>i.forEach(t=>t())}get middleware(){return[...this._middleware]}get rawState(){return this._data}get prev(){return this.safeDeepClone(this._prevData)}get state(){return new Proxy(this._data,{get:(e,i)=>{const t=e[i];return t instanceof Object?new Proxy(t,{}):t},set:()=>(console.warn("Direct state mutation is not allowed. Use setState instead."),!1)})}subscribe(e){return this._listeners.add(e),()=>this._listeners.delete(e)}validateUpdate(e){for(const i of this._validators){const t=i(e);if(t!==!0)throw new Error(typeof t=="string"?t:"Validation failed")}}update(e){const i=e(this.state);this.validateUpdate(i);const t=(n,l)=>({...n,...l});let a=t(this._data,i);for(const n of this._middleware)a=n(a,i,t);this._prevData=this.safeDeepClone(this._data),this._data=a,this.notifyListeners()}transaction(e){const i=this.state;try{this._prevData=this.safeDeepClone(this._data),this._data=e.apply(this.state),this.notifyListeners()}catch(t){throw this._data=e.rollback(i),this.notifyListeners(),t}}simpleTransaction(e){const i=e(this.state),t={};Object.keys(i).forEach(a=>{t[a]=this.state[a]}),this.transaction({apply:a=>({...a,...i}),rollback:a=>({...a,...t})})}reset(e={}){this._prevData=this.safeDeepClone(this._data),this._data=e,this.notifyListeners()}cloneState(){return this.safeDeepClone(this._data)}notifyListeners(){if(d._isNotifying){d._pendingNotifications.add(this);return}d._notificationScheduled||(d._notificationScheduled=!0,queueMicrotask(()=>{d._isNotifying=!0;try{d._pendingNotifications.forEach(e=>{e._listeners.forEach(i=>i(e._data))})}finally{d._isNotifying=!1,d._notificationScheduled=!1,d._pendingNotifications.clear()}})),d._pendingNotifications.add(this)}};d._pendingNotifications=new Set,d._isNotifying=!1,d._notificationScheduled=!1;let f=d;const w=new Set;function _(h,e){let i,t=!1;const a=Array.isArray(h)?h:[h],n=()=>{const s=a.map(r=>r.state);return Array.isArray(h)?s:s[0]},l=a.map(s=>s.subscribe(()=>{t||(i=void 0)})),o={get value(){if(t)throw new Error("Cannot access disposed computed value");if(w.has(o))throw new Error("Circular dependency detected in computed properties");if(i===void 0){w.add(o);try{i=e(n())}finally{w.delete(o)}}return i},dispose(){t||(t=!0,l.forEach(s=>s()),i=void 0)}};return typeof window<"u"&&window.addEventListener("unload",()=>o.dispose()),o}function m(h,e={}){const i=h.reduce((l,o)=>({...l,...o.state}),{});class t extends f{cleanup(){n.forEach(o=>o())}update(o){const s=o(this.state);this.validateUpdate(s),h.forEach(r=>{const u={};let y=!1;for(const c in s)c in r.state&&r.state[c]!==s[c]&&(u[c]=s[c],y=!0);y&&r.validateUpdate(u)}),super.update(r=>s),h.forEach(r=>{const u={};let y=!1;for(const c in s)c in r.state&&r.state[c]!==s[c]&&(u[c]=s[c],y=!0);if(y){const c=r.update;r.update=function(v){f.prototype.update.call(this,v)},r.update(()=>u),r.update=c}})}}const a=new t(i,{middleware:e.middleware||[],validators:e.validators||[]}),n=h.map(l=>{const o=l.update;return l.update=function(s){const r=this.state,u=s(r);this.validateUpdate(u),a.update(y=>u)},()=>{l.update=o}});return a}p.Store=f,p.computed=_,p.mixStores=m,Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
